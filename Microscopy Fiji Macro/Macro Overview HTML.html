<html><head>
<style>
@font-face{font-family:Helvetica, Arial;font-weight:400;}
body{font-family:Helvetica, Arial;}
pre{font-family:Courier New, monospace;color:#000000;padding:5px 5px;background:#eeeeee;border:1px solid #dddddd;overflow-x:auto;margin:0}
code{font-family:Courier New, monospace;}
p,ul,ol,table,pre,dl{margin:0 0 20px}
h1,h2,h3,h4,h5,h6{font-family:Helvetica, Arial;color:#222;margin:0 0 20px}
h1,h2,h3{line-height:1.1}
h1{font-size:28px}
h2{color:#393939}
h3,h4,h5,h6{color:#494949}
table{padding:5px 5px;}
th, td{font-family:Helvetica, Arial;margin:10px 10px 10px 10px; border: 1px solid #dddddd; padding: 15px;}}
</style>
</head>
<body>
<h1>Analysis of fluorescent yeast cells from microscope</h1>
<ul>
<li>August 2023</li>
</ul>
<h1>Luca Torello Pianale (Chalmers University, lucat@chalmers.se)</h1>
<p><strong>Macro Developped under ImageJ 1.53t.</strong></p>
<hr />
<p>This macro is used to <em>analyse fluorescent yeast cells from microscopy images</em></p>
<p><strong>General info</strong>:</p>
<ul>
<li>Run the macro in FIJI (www.fiji.sc) either dragging the .ijm in FIJI or selecting the file from <code>Plugins / Macros / Run...</code>.</li>
<li>The language can be both IJM Macro or IJM Macro Markdown, if a final HTML file is desired.</li>
<li><strong>Plugins Needed</strong>: Bio-Formats, Template matching, ResultsToExcel, IJMMD (if final HTML of the macro is required). If not installed already, install them from <code>Help / Update... / Manage update sites</code>.</li>
<li>For plugin Template_matching: use the built-in update manager (ImageJ's Menu&gt;Help&gt;Update...), and add the following URL via &quot;Manage update sites&quot;&gt;&quot;Add update site&quot; -&gt; http://sites.imagej.net/Template_Matching/</li>
</ul>
<p>The <strong>input folder</strong> should contain subfolders for each timepoint to be analyised with inside .tif files for each sample and channel analysed.
The file name should look like &quot;CG_t0_RAW_ch01&quot;, where &quot;CG_t0&quot; is the identifier for the sample and &quot;_ch01&quot; is the channel.</p>
<p>The <strong>output folder</strong> should contain subfolders named:</p>
<ul>
<li><em>&quot;ROIs&quot;</em> (to save the ROIs for each photo as .zip files).</li>
<li>
<ul>
<li><em>&quot;Hyperstacks&quot;</em> (to save the hyperstacks for each timepoint with brightfield and fluorescent channels with background correction (if selected) as .tif files).</li>
</ul>
</li>
<li><em>&quot;Hyperstacks_Fluo&quot;</em> (to save the hyperstacks for each timepoint with brightfield and fluorescent channel ratios (here, YFP/RFP and CFP/RPF) as .tif files).</li>
<li><em>&quot;Figures&quot;</em> (empty folder, needed for saving data analysis later on from R).</li>
<li><em>&quot;Scripts_Data_analysis&quot;</em> (folder with R scripts fordata analysis).</li>
</ul>
<p>If these are not the input/output formats (either in the files or analysis), changes should be applied in the macro.</p>
<hr />
<h1>FRESH START FOR FIJI.</h1>
<pre><code class="language-java">
close(&quot;*&quot;);
roiManager(&quot;reset&quot;);
run(&quot;Clear Results&quot;);
print(&quot;\\Clear&quot;);
roiManager(&quot;Show None&quot;);
roiManager(&quot;Associate&quot;, &quot;true&quot;);
roiManager(&quot;Centered&quot;, &quot;false&quot;);
roiManager(&quot;UseNames&quot;, &quot;false&quot;);

</code></pre>
<hr />
<h1>SET FOLDER PATHS.</h1>
<pre><code class="language-java">
input = getDirectory(&quot;Load files from directory...&quot;);
output = getDirectory(&quot;Save processed files to directory...&quot;);

YesNo = newArray(&quot;Choose!&quot;, &quot;Yes&quot;, &quot;No&quot;);
Dialog.create(&quot;Experimental presets&quot;);
	Dialog.addChoice(&quot;Make Hyperstacks?&quot;, YesNo);
	Dialog.addChoice(&quot;Backgroud Correction?&quot;, YesNo);
	Dialog.addChoice(&quot;ROI selection required?&quot;, YesNo);
Dialog.show();

makehyperstacks = Dialog.getChoice();
fluocorr = Dialog.getChoice();
ROIselect = Dialog.getChoice();

</code></pre>
<hr />
<h1>MAKE STACKS.</h1>
<pre><code class="language-java">
if (makehyperstacks == &quot;Yes&quot;) {
	
folders = getFileList(input);

for (i = 0; i &lt; folders.length; i++){
	for (k = 1; k &lt;= 4; k++){
		File.openSequence(input + folders[i] + &quot;Project/&quot;, &quot; start=&quot; + k + &quot; step=4&quot;);
		rename(&quot;C&quot; + k);
	}
	
	//Make one big hyperstack with all the images in that timepoint
	run(&quot;Merge Channels...&quot;, &quot;c1=[C1] c2=[C2] c3=[C3] c4=[C4] create&quot;);
	
	//Get the names of the samples	
	names = getFileList(input + folders[i] + &quot;Project/&quot;);
	names = Array.slice(names,1);
	
	for (l = 0; l &lt; names.length; l++){
		names[l] = substring(names[l], 8, indexOf(names[l], &quot;_RAW&quot;));
	}
	
	//Save each sample individually 
	num = nSlices/4;
	for (z = 1; z &lt;= num; z++){
		selectWindow(&quot;Composite&quot;);
		run(&quot;Make Subset...&quot;, &quot;channels=1-4 slices=&quot; + z);
		saveAs(&quot;Tiff&quot;, output + &quot;Hyperstacks/&quot; + names[(z-1)*4] + &quot;.tif&quot;);
		close();
	}
		
	close(&quot;*&quot;);
}}

</code></pre>
<hr />
<h1>BACKGROUND CORRECTION.</h1>
<pre><code class="language-java">
if (fluocorr == &quot;Yes&quot;) {
list_stacks = getFileList(output + &quot;Hyperstacks/&quot;);
Array.sort(list_stacks);

for (i = 0; i &lt; list_stacks.length; i++){
	
	//Open Hyperstack.
	filename = output + &quot;Hyperstacks/&quot; + list_stacks[i];
	open(filename);
	rename(replace(getTitle(), &quot;.tif&quot;, &quot;&quot;));
	name = getTitle();

	run(&quot;Duplicate...&quot;, &quot;duplicate&quot;);
	rename(&quot;C&quot;);
	selectWindow(name);
	close();
	selectWindow(&quot;C&quot;);
	
	//Fluorescence correction
	run(&quot;Split Channels&quot;);
	for (k = 2; k &lt;= 4; k++){
		selectWindow(&quot;C&quot; + k + &quot;-C&quot;);
		run(&quot;Subtract Background...&quot;, &quot;rolling=200 stack&quot;); 
		run(&quot;32-bit&quot;);
		setAutoThreshold(&quot;Default dark&quot;);
		run(&quot;NaN Background&quot;);	
	}
	
	//Convert bright field in 32-bit
	selectWindow(&quot;C1-C&quot;);
	run(&quot;32-bit&quot;);
	
	//Make one big hyperstack with all the images in that timepoint
	run(&quot;Merge Channels...&quot;, &quot;c1=[C1-C] c2=[C2-C] c3=[C3-C] c4=[C4-C] create&quot;);
	
	//Adjust LUTs
	color = newArray(&quot;Grays&quot;, &quot;Red&quot;, &quot;Yellow&quot;, &quot;Cyan&quot;);
	for (k = 1; k &lt;=4; k++) {
		Stack.setChannel(k);
		run(color[k-1]);
	}
	
	//Save
	saveAs(&quot;Tiff&quot;, output + &quot;Hyperstacks/&quot; + name + &quot;.tif&quot;);
	close(&quot;*&quot;);
}}

</code></pre>
<hr />
<h1>ROI SELECTION.</h1>
<pre><code class="language-java">
if (ROIselect == &quot;Yes&quot;) {
	
roiManager(&quot;Show All&quot;);
list_stacks = getFileList(output + &quot;Hyperstacks/&quot;);
Array.sort(list_stacks);

	for (i = 0; i &lt; list_stacks.length; i++){
	
		print(&quot;Analysing stack &quot; + i + 1 + &quot; of &quot; + list_stacks.length);
		print(&quot;Currently: &quot; + list_stacks[i] + &quot;&quot;);
		if (i == list_stacks.length-1) { print(&quot;Finished&quot;); } 
		else { print(&quot;Up next: &quot; + list_stacks[(i+1)] + &quot;&quot;);
		}
		
		//Open Hyperstack.
		filename = output + &quot;Hyperstacks/&quot; + list_stacks[i];
		open(filename);
		rename(replace(getTitle(), &quot;.tif&quot;, &quot;&quot;));
		name = getTitle();
	
		run(&quot;Duplicate...&quot;, &quot;duplicate&quot;);
		rename(&quot;temporary&quot;);
		selectWindow(name);
		close();
		selectWindow(&quot;temporary&quot;);
		
		//Select ROIs
		setTool(&quot;ellipse&quot;);
		if (i == 0) {
			Dialog.create(&quot;Ratio Calculation&quot;);
			Dialog.addMessage(&quot;Select the cells you want with the elliptical selection.\nAdd the selection to the ROI Manager wit Ctrl+T.\nOnce Done, press OK in the next window.&quot;);
			Dialog.show();
		}
		waitForUser(&quot;Done?&quot;);
		
		//Create an array to select all the ROIs and save them.
		ROIarray = newArray(roiManager(&quot;count&quot;));
		for (k = 0; k &lt; roiManager(&quot;count&quot;); k += 1) { ROIarray[k] = k; }
		roiManager(&quot;select&quot;, ROIarray);	
		roiManager(&quot;Save&quot;, output + &quot;ROIs/RoiSet_&quot; + name + &quot;.zip&quot;);
		
		//Prepare &quot;Fresh Start&quot; for next loop.
		roiManager(&quot;reset&quot;);
		print(&quot;\\Clear&quot;);
		close(&quot;*&quot;);
		
}}

</code></pre>
<hr />
<h1>ANALYSE STACKS.</h1>
<pre><code class="language-java">
//Preparation
Ratio_Names = newArray(&quot;Ratio_YR&quot;, &quot;Ratio_CR&quot;);
roiManager(&quot;Show All&quot;);
list_stacks = getFileList(output + &quot;Hyperstacks/&quot;);

for (i = 0; i &lt; list_stacks.length; i++){
	
	//Open Hyperstack
	filename = output + &quot;Hyperstacks/&quot; + list_stacks[i];
	open(filename);
	rename(replace(getTitle(), &quot;.tif&quot;, &quot;&quot;));
	name = getTitle();

	run(&quot;Duplicate...&quot;, &quot;duplicate&quot;);
	rename(&quot;C&quot;);
	selectWindow(name);
	close();
	selectWindow(&quot;C&quot;);
	
	//Open ROIs
	roiManager(&quot;Open&quot;, output + &quot;ROIs/RoiSet_&quot; + name + &quot;.zip&quot;);
	
	//Create an array to select all the ROIs
	ROIarray = newArray(roiManager(&quot;count&quot;));
	for (k = 0; k &lt; roiManager(&quot;count&quot;); k += 1) { ROIarray[k] = k; }
	roiManager(&quot;select&quot;, ROIarray);	
	
	//Create the YR ratio stack
	run(&quot;Split Channels&quot;);
	imageCalculator(&quot;Divide create&quot;, &quot;C3-C&quot;, &quot;C2-C&quot;);
	rename(Ratio_Names[0]);
	run(&quot;Yellow&quot;);
	selectWindow(&quot;C3-C&quot;);
	close();
		
	//Create the CR ratio stack
	imageCalculator(&quot;Divide create&quot;, &quot;C4-C&quot;, &quot;C2-C&quot;);
	rename(Ratio_Names[1]);
	run(&quot;Cyan&quot;);
	selectWindow(&quot;C4-C&quot;);
	close();
	selectWindow(&quot;C2-C&quot;);
	close();
	
	//Measure fluorescence ratio stacks and save results
	for (k = 0; k &lt; Ratio_Names.length; k++){
		run(&quot;Set Measurements...&quot;, &quot;mean standard display redirect=&quot; + Ratio_Names[k] + &quot; decimal=3&quot;);
		roiManager(&quot;select&quot;, ROIarray);
		roiManager(&quot;Measure&quot;);
	}
	
	run(&quot;Read and Write Excel&quot;, &quot;dataset_label=[&quot; + name + &quot;] no_count_column file=[&quot; + output + &quot;Results.xlsx] sheet=[&quot; + name + &quot;]&quot;);

	//Save Stacks with Ratios.
	selectWindow(&quot;C1-C&quot;);
	rename(&quot;BrightField&quot;);
	run(&quot;Grays&quot;);
	run(&quot;Images to Stack&quot;, &quot;use&quot;);
	run(&quot;Properties...&quot;, &quot;channels=3 slices=1 frames=1&quot;);
	run(&quot;Scale Bar...&quot;, &quot;width=10 height=10 font=28 color=White background=Black location=[Upper Right] bold overlay label&quot;);
	saveAs(&quot;Tiff&quot;, output + &quot;Hyperstacks_Fluo/&quot; + name + &quot;_ratios.tif&quot;);
	   
	//Prepare &quot;Fresh Start&quot; for next loop.
	roiManager(&quot;reset&quot;);
	run(&quot;Clear Results&quot;);
	print(&quot;\\Clear&quot;);
	close(&quot;*&quot;);
}

beep();
print(&quot;DONE! :D&quot;);

</code></pre>
<pre>
> DONE! :D
</pre>
<hr />
<p><strong>Done, good job!</strong> You can continue the analysis in R now!</p>



</body></html>
