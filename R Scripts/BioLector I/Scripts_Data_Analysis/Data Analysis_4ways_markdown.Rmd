---
title: "Figures and Robustness Analysis"
author: "Luca Torello Pianale"
date: "March 2023"
header-includes:
  - \usepackage{fvextra}
  - \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaksymbolleft={},showspaces = false,showtabs = false,breaklines,commandchars=\\\{\}}
output:
  pdf_document: default
  html_document: default
---

### SCOPE OF THE MARKDOWN

This code is used to analyse the data coming from BioLector I runs.


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      tidy = "styler", fig.width = 10, fig.height = 12)

options(dplyr.summarise.inform = FALSE)
```
\newpage
# GETTING STARTED.

Automatic installation of packages if required and loading libraries.

```{r libraries, message = FALSE}

#Fresh Start
rm(list = ls())
try(dev.off(dev.list()["RStudioGD"]), silent=TRUE) 

#R Version used
R.Version()[["version.string"]]

#Set new working directory
folder <- getwd()
folder <- gsub("(.+)\57Scripts(.+)", "\\1", folder)
setwd(folder)

#Additional Functions
source(paste0(folder, "/Scripts_Data_Analysis/functions.R"))

#Packages
requiredPackages <- c("tidyverse", "purrr", "readxl", "writexl",
                      "ggpubr", "ggplot2", "ggExtra", "janitor",
                      "rstatix", "deSolve", "growthrates")

loadinstall(requiredPackages)
```
\newpage  

# DATA PREPARATION

## Define general info

Set Working Directory (wd). The subfolder named "Scripts_Data_Analysis" containing this script and the file "function.R" should be placed in the same folder as the data. 
The input files should be in .xlsx format. Note that, sometimes, files will not load in R if it is open in excel!

FYI: Soft Wood (Spruce), Hard Wood (Birch), Non-Woody (oat & corn - annual, bagasse & wheat - perennial)

```{r general_info}

#Files
file <- paste0("/", list.files(folder)[startsWith(list.files(folder), "Input")])
list <- excel_sheets(paste0(folder, file))

#General info
info <- list(media = c("Delft", "SLRH60", "HGSH60", "BiH60", "WSH60", "SBH60", "CSH60", "OHH60"),
             colors_media = c("#5A5A5A", "#c2a5cf", "#A45BBD", "#7B5FCA", "#e5f5f9", "#99d8c9", "#41ae76", "#006d2c"),
             materials = c("ALL", "NON-Woody", "Woody"), 
             colors_materials = c("#e0ecf4", "#66c2a4", "#807dba"),
             strains = c("CEN.PK113-7D", "EthanolRed", "PE2"),
             colors_strains = c("#333333", "#FC8D62", "#89ADFF"),
             sensors = c("Parental", "GlyOx", "PyruEth", "RibUPR", "QUEEN", "sfpHluorin"),
             phases = c("lag", "exp", "post_exp", "ALL"),
             intraparams = c("Cell Mass", "ATP Conc.", "Intracell. pH", 
                              "Pyr. Metab.", "Ethanol Resp.", "Glycol. Flux",
                              "Rib. Abund.", "OxSR", "UPR"),
             parameters = c("mumax", "lag"),
             parameters_units =  c(lag = "Lag Phase (h)",
                                   mumax = "Max. Specific\nGrowth Rate (1/h)"))
```

## Load and Rearrange Data

```{r load}

#Load data
all_data <- map(
  list,
  ~ read_excel(paste0(folder, file), 
               sheet= .x, col_names = TRUE) %>% 
    as.data.frame() %>%
    filter(time > 0.1, time < 36.5, medium %in% info[["media"]]) %>% 
    mutate(Color = case_when(endsWith(.x, "RYC") ~ "RYC",
                             endsWith(.x, "GREEN") ~ "GREEN"),
           across(any_of(c("UVG.Norm", "biomass", "YR", "CR")), as.numeric),
           across(where(is.numeric), ~ round(., 4))) %>% 
    pivot_longer(!c(sensor, medium, time, replicate, strain, Color), 
                 names_to = "Parameter", values_to = "value")) %>%
  list_rbind() %>%
  mutate(material = case_when(
    medium %in% c("SLRH60", "HGSH60", "BiH60") ~ "Woody",
    medium %in% c("Delft") ~ "Lab",
    medium %in% c("CSH60", "OHH60", "WSH60", "SBH60") ~ "NON-Woody"))

str(all_data)

#Clean environment
rm(file, list)
```
\newpage  

# GROWTH PARAMETERS

Computing specific growth rates (mumax) and lag phases + statistical analysis.

```{r Growth_Check, fig.height = 7}

#Analysis of the growth curves for mumax. Note: in the output graphs the inflection point and the fitting curve are shown.
many_spline_fits <- all_splines(value ~ time | Color + strain + sensor + medium + material + replicate,
                                data = subset(all_data, Parameter == "biomass" & time > 2), spar = 0.2) 
par(mfrow = c(8, 8)) 
par(mar = rep(1, 4)) 
plot(many_spline_fits) 
growth_param <- results(many_spline_fits) %>%
  remove_rownames       #Saving the results


#Calculate lambda (lag phase): the coordinates of the inflection point have been extracted and used to calculate the tangent and subsequently the x value corresponding to the lag phase.
inf_points <- NULL

for (i in 1:length(many_spline_fits@fits)){
  tmp <- many_spline_fits@fits[[i]]@xy
  inf_points <- rbind(inf_points, tmp)
  rm(tmp)
}

inf_points <- as.data.frame(inf_points)

growth_param <- bind_cols(growth_param, inf_points) %>%
  rename(., x = V1, y = V2) %>%
  mutate(lag = ((log10(y0) - log10(y)) / mumax) + x) %>%
  pivot_longer(c(lag, mumax), names_to = "Parameter", values_to = "value")


#Adjust some false predictions 
growth_param$value[growth_param$strain == "CEN.PK113-7D" & growth_param$medium %in% c("BiH60", "HGSH60") & growth_param$Parameter == "lag" & growth_param$replicate == 1] <- 36
growth_param$value[growth_param$strain == "CEN.PK113-7D" & growth_param$medium %in% c("BiH60", "HGSH60") & growth_param$Parameter == "lag" & growth_param$replicate == 2] <- 35.9
growth_param$value[growth_param$strain == "CEN.PK113-7D" & growth_param$medium %in% c("BiH60", "HGSH60") & growth_param$Parameter == "lag" & growth_param$replicate == 3] <- 35.99

growth_param$value[growth_param$strain == "CEN.PK113-7D" & growth_param$medium %in% c("BiH60", "HGSH60") & growth_param$Parameter == "mumax" & growth_param$replicate == 1] <- 0.001
growth_param$value[growth_param$strain == "CEN.PK113-7D" & growth_param$medium %in% c("BiH60", "HGSH60") & growth_param$Parameter == "mumax" & growth_param$replicate == 2] <- 0.0011
growth_param$value[growth_param$strain == "CEN.PK113-7D" & growth_param$medium %in% c("BiH60", "HGSH60") & growth_param$Parameter == "mumax" & growth_param$replicate == 3] <- 0.0012


#Statistical comparison of mumax and lag for each medium with respect to the parental strain.
Stats_strain <- compare_means(value~sensor, data = growth_param, 
                              group.by = c("Color", "strain", "medium", "Parameter"), 
                              method = "t.test", ref.group = "Parental") %>% 
  add_significance("p.adj") %>%
  add_x_position(., x = "medium", group = "sensor", dodge = 0.9) 

#Statistical comparison of mumax and lag among different media with respect to the control "Delft".
Stats_medium <- compare_means(value~medium, data = growth_param, 
                              group.by = c("Color", "strain", "Parameter"), 
                              method = "t.test", ref.group = "Delft") %>% 
  add_significance("p.adj") 

#Clean environment
rm(inf_points, many_spline_fits, i)
```
\newpage 

# GROWTH PHASES

In order to compute the robstness for the intracellular parameters, specific growth phases will be taken into account. Therefore, key points will be taken into account. 

```{r growth_phases}

#Identify end of lag phase and end of exponential phase.
grouping <- c("Color", "strain", "sensor", "medium", "material", "replicate")

end_lag <- distinct(all_data[, c(grouping, "time")]) %>%
  merge(., subset(growth_param, 
                  Parameter == "lag")[, c(grouping, "value")]) %>%
  mutate(diff = abs(time - value)) %>%
  group_by(Color, strain, sensor, medium, replicate) %>%
  filter(diff == min(diff)) %>%     #Closest timepoints to lag phase lengths
  select(-c(value, diff)) %>%
  rename(end_lag = time)

end_exp <- all_data[, c(grouping, "time", "Parameter", "value")] %>%
  filter(Parameter == "biomass") %>%
  filter(strain != "CEN.PK113-7D" | medium != "BiH60") %>%
  filter(strain != "CEN.PK113-7D" | medium != "HGSH60") %>%
  merge(., distinct(growth_param[, c(grouping, "x")])) %>%
  filter(time > x) %>%
  group_by(Color, strain, sensor, medium, replicate) %>%
  arrange(time, .by_group = TRUE) %>%
  mutate(endlog = lead(value, 3)-value) %>%
  filter(endlog < 0.2) %>%
  arrange(time, .by_group = TRUE) %>%
  slice_head() %>%
  select(-c(x, endlog, Parameter, value)) %>%
  rename(end_exp = time)

points <- merge(end_lag, end_exp, all.x = T) %>% 
  mutate(end_exp = if_else(is.na(end_exp), 37, end_exp))


#Divide the curves into phases
all_data <- merge(all_data, points, all.x = T) %>%
  mutate(across(where(is.numeric), ~ round(.,3)),
         Phase = case_when(
           time > end_exp & time > end_lag ~ "post_exp",
           time <= end_exp & time > end_lag ~ "exp", 
           time < end_exp & time <= end_lag ~ "lag")) %>%
  select(-c(end_lag, end_exp)) %>%
  group_by(Color, strain, sensor, medium, replicate, Parameter) %>% 
  arrange(time, .by_group = TRUE) %>%
  mutate(value = ifelse(Parameter == "biomass", 
                        log(value/first(value)), value)) %>%  #Normalise biomass by first value and convert into log scale
  ungroup()  

#Clean environment
rm(end_lag, end_exp, points, grouping)
```
\newpage  

# ROBUSTNESS

```{r Robustness}

#Check robustness for growth and lag phase.
R_growth <- growth_param %>%
  select(-c(x, y, y0, r2)) %>%
  ungroup() %>%
  rbind(., mutate(., material = "ALL")) %>%
  filter(material != "Lab") %>% 
  robust(., colR = value, groupm = c(Parameter, material),
         groupR = c(strain, Parameter, material)) 
str(R_growth)

#Check robustness for Intracellular Parameters
R_fluo <- all_data %>%
  filter(sensor != "Parental") %>%
  filter(Parameter != "biomass") %>%
  rbind(., mutate(., Phase = "ALL")) %>%
  ungroup() %>%
  robust(., colR = value, groupm = c(sensor, Parameter, Phase),
         groupR = c(Color, material, strain, medium, sensor, Parameter, replicate, Phase)) %>%
  mutate(IntraParam = case_when(
    Parameter == "biomass" ~ "Cell Mass",
    Parameter == "CR" & sensor == "PyruEth" ~ "Ethanol Resp.",
    Parameter == "YR" & sensor == "PyruEth" ~ "Pyr. Metab.",
    Parameter == "CR" & sensor == "RibUPR" ~ "Rib. Abund.",
    Parameter == "YR" & sensor == "RibUPR" ~ "UPR",
    Parameter == "CR" & sensor == "GlyOx" ~ "Glycol. Flux",
    Parameter == "YR" & sensor == "GlyOx" ~ "OxSR",
    Parameter == "UVG.Norm" & sensor == "QUEEN" ~ "ATP Conc.",
    Parameter == "UVG.Norm" & sensor == "sfpHluorin" ~ "Intracell. pH")) %>%
  ungroup() %>% 
  rbind(., mutate(., material = "ALL")) %>% 
  filter(material != "Lab")

str(R_fluo)
```

# EXPORT DATA

```{r Export_data}

#Export data in an excel sheet (.xlsx). Add to the list all the data frames to be saved in each sheet.
sheets <- list("Data" = as.data.frame(all_data), 
               "R_fluo" = as.data.frame(R_fluo), 
               "R_growth" = as.data.frame(R_growth),
               "Growth_Param" = as.data.frame(growth_param), 
               "Strain_Compare" = as.data.frame(Stats_strain), 
               "Medium_Compare" = as.data.frame(Stats_medium)) 
write_xlsx(sheets, path = paste0(folder, "/Full_Analysis.xlsx"), use_zip64 = TRUE)
rm(sheets)
```
\newpage 
# DATA PLOTTING
## Data re-organisation

For more efficient plotting, the data frame with the data is being re-organised.

```{r reorganise_data}

all_data <- all_data %>%
  mutate(IntraParam = case_when(
    Parameter == "biomass" ~ "Cell Mass",
    Parameter == "CR" & sensor == "PyruEth" ~ "Ethanol Resp.",
    Parameter == "YR" & sensor == "PyruEth" ~ "Pyr. Metab.",
    Parameter == "CR" & sensor == "RibUPR" ~ "Rib. Abund.",
    Parameter == "YR" & sensor == "RibUPR" ~ "UPR",
    Parameter == "CR" & sensor == "GlyOx" ~ "Glycol. Flux",
    Parameter == "YR" & sensor == "GlyOx" ~ "OxSR",
    Parameter == "UVG.Norm" & sensor == "QUEEN" ~ "ATP Conc.",
    Parameter == "UVG.Norm" & sensor == "sfpHluorin" ~ "Intracell. pH"))

#Re-organizing data frames for plotting
map(names(Filter(is.data.frame, as.list(.GlobalEnv))),
    ~ eval(as.symbol(.x)) %>%
       mutate(strain = factor(strain, levels = info[["strains"]]),
              across(any_of(c("sensor")), 
                     ~factor(sensor, levels = info[["sensors"]])),
              across(any_of(c("material")), 
                     ~factor(material, levels = info[["materials"]])),
              across(any_of(c("medium")),
                     ~factor(medium, levels = info[["media"]])),
              across(any_of(c("Phase")), 
                     ~factor(Phase, levels = info[["phases"]])),
              across(any_of(c("IntraParam")), 
                     ~factor(IntraParam, levels = info[["intraparams"]])),
              across(any_of(c("Parameter")), 
                     ~factor(Parameter, levels = info[["parameters"]])))) %>% 
    setNames(names(Filter(is.data.frame, as.list(.GlobalEnv)))) %>% 
    list2env(.GlobalEnv)
```
\newpage  
## Barplots 
### Supplementary Figure 2

```{r S3, echo = FALSE}
#Make figure
for(i in c("lag", "mumax")) {
  df1 <- subset(growth_param, Parameter == i)
  
  assign(paste0(i, "_bar"), 
         ggplot(data = df1) + aes(x = medium, y = value, group = sensor) +
           stat_summary(aes(fill = medium), fun = mean, geom = "bar", 
                        position = position_dodge(width = 0.9)) +
           stat_summary(fun.data = mean_sdl, geom = "errorbar", 
                        fun.args = list(mult = 1),
                        width = 0.1, position = position_dodge(width = 0.9)) +
           stat_summary(aes(x = medium, y = value/2, shape = sensor), 
                        fun = mean, geom = "point", color = "black",
                        size = 3, position = position_dodge(width = 0.9)) +
           stat_pvalue_manual(data = subset(Stats_strain, Parameter == i), 
                              label = "p.adj.signif", group = "group2",
                              remove.bracket = T, hide.ns = T,
                              y.position = 10) +
           stat_pvalue_manual(data = subset(Stats_medium, Parameter == i), 
                              label = "p.adj.signif", 
                              remove.bracket = T, hide.ns = T,
                              y.position = -max(df1$value)*0.1) +
           scale_y_continuous(limits = c(-max(df1$value)*0.1, max(df1$value)*1.15)) +
           scale_fill_manual(breaks = info[["media"]], 
                             values = info[["colors_media"]]) +
           facet_grid(rows = vars(strain)) +
           theme_light() +
           theme(legend.position = "right",
                 legend.box="vertical",
                 axis.title.x = element_blank(),
                 axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
                 axis.text.y = element_text(size = 10),
                 strip.background = element_rect(colour = "white", fill = "black"),
                 strip.text = element_text(size = 10, face = "bold.italic"),
                 panel.grid.minor.x = element_blank(), 
                 panel.grid.major.x = element_blank(),
                 plot.margin = unit(rep(0.5, 4), "cm")))
  
  if(i == "mumax") {mumax_bar <- mumax_bar + labs(y = expression(paste("Max. Specific\nGrowth Rate (h"^"-1", ")")))} 
  if(i == "lag") {lag_bar <- lag_bar + labs(y = "Lag Phase (h)\n")} 
  
  rm(df1)
}


#Supplementary Figure 3
Supp_fig2 <- ggarrange(mumax_bar, lag_bar, 
                       ncol = 1, nrow = 2, 
                       labels = c("a", "b"))

rm(i, list = c(ls()[endsWith(ls(), "_bar")], ls()[startsWith(ls(), "Stats")]))
#Supp_fig2
```
\newpage  
## Barplots  
### Figure 4b  

```{r 2A, echo = FALSE}

Fig4b <- ggplot(data = growth_param) + 
  aes(x = medium, y = value) +
  stat_summary(aes(fill = medium), fun = mean, geom = "bar", 
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = mean_sdl, geom = "errorbar", 
               fun.args = list(mult = 1),
               width = 0.1, position = position_dodge(width = 0.9)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)), 
                     labels = function(x) format(x, nsmall = 1),
                     breaks = scales::extended_breaks(n = 3)) +
  scale_fill_manual(breaks = info[["media"]], 
                    values = info[["colors_media"]]) +
  facet_grid(cols = vars(strain),
             rows = vars(Parameter),
             switch = "y", scales = "free",
             labeller = labeller(Parameter = info[["parameters_units"]])) +
  labs(x = "", y = "") +
  guides(fill = guide_legend(ncol = 1)) +
  theme_light() +
  theme(legend.position = "right",
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 9),
        axis.ticks.x = element_blank(),
        strip.placement.y = "outside",
        strip.background.x = element_rect(colour = "black", fill = "black"),
        strip.background.y = element_blank(),
        strip.text.x = element_text(size = 9, face = "bold.italic", colour = "white"),
        strip.text.y = element_text(size = 9, colour = "black"),
        panel.spacing.x = unit(0.3, "lines"),
        panel.spacing.y = unit(0.7, "lines"), 
        panel.grid.minor = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.margin = unit(rep(0.3, 4), "cm"))

#Fig4b
```
\newpage 
## Lineplots 
### Supplementary Figure 3a

```{r S3A, echo = FALSE}

Supp_fig3a <- ggplot(data = all_data %>% 
                       filter(Color == "RYC", IntraParam == "Cell Mass")) + 
  aes(x = time, y = value, colour = strain) +
  stat_summary(fun = mean, geom = "line", linewidth = 1) +
  stat_summary(fun.data = mean_sdl, geom = "errorbar", 
               fun.args = list(mult = 1), width = 0.05, alpha = 0.5) +
  scale_x_continuous(breaks = seq(from = 0, 
                                  to = max(unique(all_data$time)), 
                                  by = 12)) +
  scale_y_continuous(labels = function(x) format(x, nsmall = 1)) +
  scale_color_manual(breaks = info[["strains"]], 
                     values = info[["colors_strains"]]) +
  labs(y = "ln(Norm. Scattered Light) (a.u.)\n", x = "\nTime (h)") +
  facet_wrap(~medium, nrow = 2) +
  theme_light()+ 
  theme(legend.position = "top",
        axis.title = element_text(size = 9),
        axis.text = element_text(size = 9),
        panel.grid.minor = element_blank(),
        panel.spacing.x = unit(1, "lines"), 
        strip.background = element_rect(colour = "white", fill = "black"),
        strip.text = element_text(size = 9, face = "bold.italic"),
        plot.margin = unit(rep(0.3, 4), "cm"))

#Supp_fig3a
```
\newpage
## Lineplots 
### Supplementary Figure 4

```{r S4, echo = FALSE}

#Reorganise data for lineplots
line_data <- all_data %>%
  ungroup() %>%
  filter(sensor != "Parental", 
         IntraParam != "Cell Mass") %>% 
  rbind(., subset(all_data, sensor == "Parental" & IntraParam == "Cell Mass" & Color == "RYC")) 
  #%>% 
  # group_by(Color, strain, sensor, medium, replicate, IntraParam) %>% 
  # arrange(time, .by_group = TRUE) %>% 
  # mutate(value = ifelse(IntraParam != "Cell Mass", 
  #                       value/first(value), value))


#General aestethic for lineplots.
Supp_fig4 <- ggplot(data = line_data) +
  aes(x = time, y = value, colour = strain) +
  stat_summary(fun = mean, geom = "line", linewidth = 1) +
  stat_summary(fun.data = mean_sdl, geom = "errorbar", 
               fun.args = list(mult = 1), width = 0.1, alpha = 0.4) +
  scale_x_continuous(breaks = seq(from = 0, to = max(unique(all_data$time)), by = 12)) +
  scale_y_continuous(labels = function(x) format(x, nsmall = 1)) +
  scale_color_manual(breaks = info[["strains"]], 
                     values = info[["colors_strains"]]) +
  labs(y = "", x = "Time (h)") +
  facet_grid(rows = vars(IntraParam), 
             cols = vars(medium), scales = "free") +
  theme_light() +
  theme(legend.position = "top",
        axis.title = element_text(size = 11),
        axis.text = element_text(size = 11),
        panel.grid.minor = element_blank(),
        strip.background = element_rect(colour = "white", fill = "black"),
        plot.margin = unit(rep(0.5, 4), "cm"))


rm(line_data)
#Supp_fig4
```
\newpage 
## Boxplot 
### Figure 5b

```{r 3, echo = FALSE}
tmp <- all_data %>% 
  filter(IntraParam != "Cell Mass") %>% 
  rbind(., mutate(., material = "ALL")) %>% 
  drop_na(material) %>% 
  group_by(strain, material, medium, IntraParam, replicate) %>% 
  mutate(value = mean(value), 
         .keep = "none") %>% 
  distinct()

Fig5b <- ggplot(data = tmp) + 
  aes(x = strain, y = value, fill = strain) +
  geom_boxplot(alpha = 0.7,
               outlier.size = 0.5) +
  stat_summary(fun = mean, geom = "point", color = "red",
               position = position_dodge(width = 0.9)) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1)), 
                     labels = function(x) format(x, nsmall = 1),
                     breaks = scales::extended_breaks(n = 3)) +
  scale_fill_manual(breaks = info[["strains"]], 
                    values = info[["colors_strains"]]) +
  facet_wrap(~ IntraParam, 
             ncol = 3, scales = "free") +
  labs(x = "", y = "Fluorescence (a.u.)\n") +
  theme_light() +
  theme(legend.position = c(0.87, 0.18), #(1,1) top right, (0,0) bottom left
        legend.background = element_rect(linewidth = 0.2, 
                                         colour = "black",
                                         linetype = "solid"),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 9),
        axis.ticks.x = element_blank(),
        strip.placement.y = "outside",
        strip.background = element_rect(colour = "black", fill = "black"),
        strip.text = element_text(size = 9, face = "bold.italic", colour = "white"),
        panel.spacing.x = unit(0.3, "lines"),
        panel.spacing.y = unit(0.7, "lines"), 
        panel.grid.minor = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.margin = unit(rep(0.3, 4), "cm"))

#Fig5b
rm(tmp)
```
\newpage 
## Boxplot 
### Supplementary Figure 5

```{r S5, echo = FALSE}
tmp <- all_data %>% 
  filter(IntraParam != "Cell Mass") %>% 
  rbind(., mutate(., material = "ALL")) %>% 
  drop_na(material) %>% 
  group_by(strain, material, medium, Phase, IntraParam, replicate) %>% 
  mutate(value = mean(value), 
         .keep = "none") %>% 
  distinct()

Supp_fig5 <- ggplot(data = subset(tmp, Phase != "post_exp")) +
  aes(x = strain, y = value, fill = material) +
  geom_boxplot(outlier.size = 0.5) +
  stat_summary(fun = mean, geom = "point", 
               color = "red", size = 1,
               position = position_dodge(width = 0.75)) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), 
                     labels = function(x) format(x, nsmall = 1)) +
  scale_fill_manual(breaks = info[["materials"]], 
                    values = info[["colors_materials"]]) +
  facet_grid(cols = vars(Phase),
             rows = vars(IntraParam), scales = "free",
             labeller = labeller(Phase = c(lag = "Lag Phase", 
                                           exp = "Exponential Phase",
                                           post_exp = "Post-Exponential Phase"))) +
  labs(x = "", y = "Fluorescence (a.u.)\n") +
  theme_light() +
  theme(legend.position = "top", legend.box="vertical",
        axis.text.x = element_text(size = 8, face = "bold",
                                   colour = info[["colors_strains"]]),
        axis.text.y = element_text(size = 8),
        strip.background = element_rect(colour = "white", 
                                        fill = "black"),
        strip.text = element_text(size = 8, face = "bold.italic"),
        panel.spacing.y = unit(0.5, "lines"), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.margin = unit(rep(0.1, 4), "cm"))

#Supp_fig5
rm(tmp)
```
\newpage 
## Robustness
### Figure 4c

```{r 2B, echo = FALSE}

Fig4c <- ggplot(data = subset(R_growth, material == "ALL")) +
  geom_point(aes(x = mean_value, y = Rn, color = strain), size = 3) +
  geom_errorbarh(aes(xmax = mean_value + sd_value, 
                     xmin = mean_value - sd_value, 
                     y = Rn, color = strain), height = 0) +
  labs(x = NULL, y = "R(c) (a.u.)\n") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)), 
                     labels = function(x) format(x, nsmall = 1),
                     limits = c(NA, 0),
                     breaks = scales::extended_breaks(n = 3)) +
  scale_x_continuous(breaks = scales::extended_breaks(n = 4, 
                                                      w = c(0.25, 0.2, 0.9, 0.05))) +
  facet_wrap(~Parameter, ncol = 2,
             scales = "free",  strip.position = "bottom",
             labeller = labeller(Parameter = info[["parameters_units"]])) +
  scale_color_manual(breaks = info[["strains"]], 
                     values = info[["colors_strains"]]) +
  theme_light() +
  theme(legend.position = "top",
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 9),
        strip.placement = "outside",
        strip.background.y = element_rect(colour = "black", fill = "black"),
        strip.background.x = element_blank(),
        strip.text.y = element_text(size = 9, face = "bold.italic", colour = "white"),
        strip.text.x = element_text(size = 9, colour = "black"),
        panel.spacing.x = unit(1, "lines"),
        panel.spacing.y = unit(1.5, "lines"), 
        panel.grid.minor = element_blank(), 
        plot.margin = unit(rep(0.6, 4), "cm"))

#Fig4c
```
\newpage 
## Robustness
### Supplementary Figure 3b

```{r S3B, echo = FALSE}

Supp_fig3b <- ggplot(data = subset(R_growth, material != "ALL")) +
  geom_point(aes(x = mean_value, y = Rn, color = strain), size = 3) +
  geom_errorbarh(aes(y = Rn, xmax = mean_value + sd_value, 
                     xmin = mean_value - sd_value, 
                     color = strain), 
                 height = 0) +
  labs(x = NULL, 
       y = "R(c) (a.u.)\n") +
  scale_y_continuous(expand = expansion(mult = c(0.1, 0.1)), 
                     labels = function(x) format(x, nsmall = 1),
                     limits = c(NA, 0)) +
  facet_grid(cols = vars(Parameter), rows = vars(material), 
             scales = "free",  switch = "x",
             labeller = labeller(Parameter = c(lag = "Lag Phase (h)", 
                                               mumax = "Max. Specific Growth Rate (1/h)"))) +
  scale_color_manual(breaks = info[["strains"]], 
                     values = info[["colors_strains"]]) +
  theme_light() +
  theme(legend.position = "top", 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.text.y = element_text(size = 10),
        strip.placement = "outside",
        strip.background.y = element_rect(colour = "black", fill = "black"),
        strip.background.x = element_blank(),
        strip.text.y = element_text(size = 10, face = "bold.italic", colour = "white"),
        strip.text.x = element_text(size = 10, colour = "black"),
        panel.spacing.x = unit(1, "lines"),
        panel.spacing.y = unit(0.7, "lines"), 
        panel.grid.minor = element_blank(), 
#        panel.grid.major = element_blank(),
        plot.margin = unit(rep(0.3, 4), "cm"))

#Supp_fig3b
```
\newpage 
## Robustness
### Figure 6b

```{r 6, echo = FALSE}

Fig6b <- ggplot(data = subset(R_fluo, Phase == "ALL" & material == "ALL")) +
  aes(x = strain, y = Rn, fill = strain) +
  geom_boxplot(alpha = 0.7,
               outlier.size = 0.5) +
  stat_summary(fun = mean, geom = "point", 
               color = "red", size = 1,
               position = position_dodge(width = 0.75)) +
  # stat_summary(fun.data = mean_se, geom = "errorbar",
  #              fun.args = list(mult = 1),
  #              width = 0.05, position = position_dodge(width = 0.9)) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), 
                     labels = function(x) format(x, nsmall = 1)) +
  scale_fill_manual(breaks = info[["strains"]], 
                     values = info[["colors_strains"]]) +
  labs(x = "", y = "R(t) (a.u.)\n") +
  facet_wrap(~ IntraParam, 
             ncol = 3, scales = "free") +
  theme_light() +
  theme(legend.position = c(0.87, 0.18), #(1,1) top right, (0,0) bottom left
        legend.background = element_rect(linewidth = 0.2, 
                                         colour = "black",
                                         linetype = "solid"),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 8),
        strip.background = element_rect(colour = "white", 
                                        fill = "black"),
        strip.text = element_text(size = 8, face = "bold.italic"),
        panel.spacing.x = unit(1, "lines"),
        panel.spacing.y = unit(0.7, "lines"), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.margin = unit(rep(0.3, 4), "cm"))

#Fig6b
```
\newpage  
## Robustness
### Supplementary Figure 6

```{r S6, echo = FALSE}

Supp_fig6left <- ggplot(data = subset(R_fluo, Phase %in% c("lag"))) +
  aes(x = strain, y = Rn, fill = material) +
  geom_boxplot(outlier.size = 0.5) +
  stat_summary(fun = mean, geom = "point", 
               color = "red", size = 1,
               position = position_dodge(width = 0.75)) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), 
                     labels = function(x) format(x, nsmall = 1)) +
  scale_fill_manual(breaks = info[["materials"]], 
                    values = info[["colors_materials"]]) +
  labs(x = "", y = "R(t) (a.u.)\n") +
  facet_grid(cols = vars(Phase), 
             rows = vars(IntraParam), scales = "free",
             labeller = labeller(Phase = c(lag = "Lag Phase", 
                                           exp = "Exponential Phase"))) +
  theme_light() +
  theme(legend.position = "top", legend.box="vertical",
        axis.text.x = element_text(size = 8, face = "bold",
                                   colour = info[["colors_strains"]]),
        axis.text.y = element_text(size = 8),
        strip.background.y = element_blank(),
        strip.text.y = element_blank(),
        strip.background.x = element_rect(colour = "white", 
                                        fill = "black"),
        strip.text.x = element_text(size = 8, face = "bold.italic"),
        panel.spacing.y = unit(0.5, "lines"), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.margin = unit(rep(0.1, 4), "cm"))

Supp_fig6right <- ggplot(data = subset(R_fluo, Phase %in% c("exp"))) +
  aes(x = strain, y = Rn, fill = material) +
  geom_boxplot(outlier.size = 0.5) +
  stat_summary(fun = mean, geom = "point", 
               color = "red", size = 1,
               position = position_dodge(width = 0.75)) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.05)), 
                     labels = function(x) format(x, nsmall = 1)) +
  scale_fill_manual(breaks = info[["materials"]], 
                    values = info[["colors_materials"]]) +
  labs(x = "", y = "") +
  facet_grid(cols = vars(Phase), 
             rows = vars(IntraParam), scales = "free",
             labeller = labeller(Phase = c(lag = "Lag Phase", 
                                           exp = "Exponential Phase"))) +
  theme_light() +
  theme(legend.position = "top", legend.box="vertical",
        axis.text.x = element_text(size = 8, face = "bold",
                                   colour = info[["colors_strains"]]),
        axis.text.y = element_text(size = 8),
        strip.background = element_rect(colour = "white", 
                                        fill = "black"),
        strip.text = element_text(size = 8, face = "bold.italic"),
        panel.spacing.y = unit(0.5, "lines"), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.x = element_blank(),
        plot.margin = unit(rep(0.1, 4), "cm"))

Supp_fig6 <- ggarrange(Supp_fig6left, Supp_fig6right,
                       legend.grob = get_legend(Supp_fig6left, position = "top"),
                       ncol = 2, nrow = 1)
#Supp_fig6
```
\newpage  
# SAVE IMAGES.  

```{r Saving_figs}
#Figure 4
Fig4 <- ggarrange(Fig4b, Fig4c,
                  ncol = 1, nrow = 2, 
                  labels = c("b", "c"),
                  heights = c(1, 0.85))

ggsave(filename = "Figure 4bc.png", 
       plot = Fig4, device = "png", path = folder, 
       width = 16, height = 15, unit = "cm", dpi = 300)

#Figure 5
ggsave(filename = "Figure 5b.png", 
       plot = Fig5b, device = "png", path = folder, 
       width = 15, height = 12, unit = "cm", dpi = 300)

#Figure 6b
ggsave(filename = "Figure 6b.png", 
       plot = Fig6b, device = "png", path = folder, 
       width = 15, height = 12, unit = "cm", dpi = 300)


#Supplementary Figure 2
ggsave(filename = "Supplementary Figure 2.png", 
       plot = Supp_fig2, device = "png", path = folder, 
       width = 17, height = 15, unit = "cm", dpi = 300, scale = 2)

#Supplementary Figure 3
Supp_fig3 <- ggarrange(Supp_fig3a, Supp_fig3b,
                  ncol = 1, nrow = 2, 
                  labels = c("a", "b"),
                  heights = c(1, 0.8))

ggsave(filename = "Supplementary Figure 3.png", 
       plot = Supp_fig3, device = "png", path = folder, 
       width = 15, height = 20, unit = "cm", dpi = 300)

#Supplementary Figure 4
ggsave(filename = "Supplementary Figure 4.png", 
       plot = Supp_fig4, device = "png", path = folder, 
       width = 17, height = 20, unit = "cm", dpi = 300, scale = 1.5)

#Supplementary Figure 5
ggsave(filename = "Supplementary Figure 5.png", 
       plot = Supp_fig5, device = "png", path = folder, 
       width = 16, height = 20, unit = "cm", dpi = 300)

#Supplementary Figure 6
ggsave(filename = "Supplementary Figure 6.png", 
       plot = Supp_fig6, device = "png", path = folder, 
       width = 17, height = 20, unit = "cm", dpi = 300)
```
\newpage  
# CITATIONS 

Citations of R Studio and packages used in this script. 

```{r Citations, echo = FALSE}

print(citation(), style = "text")

for(i in c("rmarkdown", requiredPackages)) {
  print(i); print(citation(i), style = "text"); cat('\n')
}
```
